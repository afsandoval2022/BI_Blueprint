<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Análisis de Cohorte y RFM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chart-container {
            position: relative;
            height: 40vh;
            width: 100%;
        }
    </style>
</head>
<body class="bg-gray-900 text-white p-4 sm:p-6 lg:p-8">
    <div class="max-w-7xl mx-auto">
        
        <!-- Encabezado -->
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-cyan-400">Dashboard de Análisis de Cohorte y RFM</h1>
            <p class="text-gray-400 mt-1">Visualización interactiva del comportamiento de los clientes.</p>
        </header>

        <!-- KPIs -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                <h3 class="text-sm font-medium text-gray-400">Total Clientes</h3>
                <p id="total-customers" class="text-2xl font-semibold text-white">0</p>
            </div>
            <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                <h3 class="text-sm font-medium text-gray-400">Recencia Promedio</h3>
                <p id="avg-recency" class="text-2xl font-semibold text-white">0</p>
            </div>
            <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                <h3 class="text-sm font-medium text-gray-400">Frecuencia Promedio</h3>
                <p id="avg-frequency" class="text-2xl font-semibold text-white">0</p>
            </div>
            <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                <h3 class="text-sm font-medium text-gray-400">Gasto Promedio</h3>
                <p id="avg-monetary" class="text-2xl font-semibold text-white">0</p>
            </div>
        </div>

        <!-- Filtros -->
        <div class="bg-gray-800 p-4 rounded-lg shadow-lg mb-8">
            <h2 class="font-semibold text-lg mb-4">Filtros de Segmento RFM</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label for="r-label-filter" class="block text-sm font-medium text-gray-300 mb-1">Recencia (R)</label>
                    <select id="r-label-filter" class="w-full bg-gray-700 border-gray-600 text-white rounded-md p-2 focus:ring-cyan-500 focus:border-cyan-500"></select>
                </div>
                <div>
                    <label for="f-label-filter" class="block text-sm font-medium text-gray-300 mb-1">Frecuencia (F)</label>
                    <select id="f-label-filter" class="w-full bg-gray-700 border-gray-600 text-white rounded-md p-2 focus:ring-cyan-500 focus:border-cyan-500"></select>
                </div>
                <div>
                    <label for="m-label-filter" class="block text-sm font-medium text-gray-300 mb-1">Gasto (M)</label>
                    <select id="m-label-filter" class="w-full bg-gray-700 border-gray-600 text-white rounded-md p-2 focus:ring-cyan-500 focus:border-cyan-500"></select>
                </div>
            </div>
        </div>

        <!-- Gráficos -->
        <main class="space-y-8">
            <!-- Gráfico de Evolución de Cohortes -->
            <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                <h2 class="text-xl font-semibold mb-4">Evolución del Estado de los Clientes por Periodo</h2>
                <div class="chart-container">
                    <canvas id="cohort-chart"></canvas>
                </div>
            </div>

            <!-- Gráficos de Distribución RFM -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold mb-4">Distribución por Recencia</h2>
                    <div class="chart-container h-64">
                        <canvas id="recency-chart"></canvas>
                    </div>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold mb-4">Distribución por Frecuencia</h2>
                     <div class="chart-container h-64">
                        <canvas id="frequency-chart"></canvas>
                    </div>
                </div>
                <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold mb-4">Distribución por Gasto</h2>
                     <div class="chart-container h-64">
                        <canvas id="monetary-chart"></canvas>
                    </div>
                </div>
            </div>
        </main>

    </div>

    <script>
        const csvData = `idCustomer,Recency,Frequency,Monetary,R_score,F_score,M_score,R_label,F_label,M_label,Estado_1,Estado_2,Estado_3,Estado_4,Estado_5,Estado_6,Estado_7,Estado_8,Estado_9,Estado_10,Estado_11,Estado_12
1,9.0,20,1215.57,3,3,3,Moderadamente reciente,Moderada frecuencia,Moderado gasto,Activo,Recompra,Desercion,Regreso,Desercion,Repite desersion,Regreso,Recompra,Recompra,Recompra,Recompra,Recompra
2,18.0,17,1069.55,2,1,1,Poco reciente,Menos frecuente,Menor gasto,Activo,Recompra,Recompra,Recompra,Desercion,Regreso,Desercion,Regreso,Recompra,Desercion,Regreso,Recompra
3,7.0,24,1511.96,3,4,4,Moderadamente reciente,Más frecuente,Mayor gasto,Activo,Recompra,Recompra,Desercion,Regreso,Recompra,Desercion,Regreso,Recompra,Recompra,Recompra,Recompra
4,36.0,20,1246.31,1,3,3,Menos reciente,Moderada frecuencia,Moderado gasto,Activo,Recompra,Desercion,Regreso,Recompra,Recompra,Desercion,Regreso,Recompra,Recompra,Recompra,Desercion
5,6.0,10,611.26,4,1,1,Más reciente,Menos frecuente,Menor gasto,Null,Activo,Recompra,Desercion,Repite desersion,Repite desersion,Repite desersion,Repite desersion,Repite desersion,Regreso,Recompra,Recompra
6,19.0,17,1022.36,2,1,1,Poco reciente,Menos frecuente,Menor gasto,Null,Null,Activo,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra
7,19.0,15,991.58,2,1,1,Poco reciente,Menos frecuente,Menor gasto,Null,Activo,Recompra,Desercion,Regreso,Recompra,Recompra,Recompra,Recompra,Recompra,Desercion,Regreso
8,8.0,27,1589.46,3,4,4,Moderadamente reciente,Más frecuente,Mayor gasto,Activo,Recompra,Desercion,Regreso,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra
9,7.0,17,1025.34,3,1,1,Moderadamente reciente,Menos frecuente,Menor gasto,Activo,Recompra,Recompra,Recompra,Desercion,Regreso,Desercion,Regreso,Recompra,Recompra,Recompra,Recompra
10,11.0,18,1123.63,3,2,2,Moderadamente reciente,Baja frecuencia,Bajo gasto,Activo,Recompra,Recompra,Desercion,Regreso,Recompra,Recompra,Desercion,Regreso,Recompra,Recompra,Recompra
11,14.0,18,1123.27,2,2,2,Poco reciente,Baja frecuencia,Bajo gasto,Activo,Recompra,Recompra,Desercion,Regreso,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra
12,1.0,22,1347.04,4,3,4,Más reciente,Moderada frecuencia,Mayor gasto,Activo,Desercion,Regreso,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra,Desercion,Regreso
13,9.0,21,1255.35,3,3,3,Moderadamente reciente,Moderada frecuencia,Moderado gasto,Activo,Desercion,Regreso,Recompra,Recompra,Desercion,Regreso,Recompra,Recompra,Recompra,Recompra,Recompra
14,47.0,17,1030.92,1,1,1,Menos reciente,Menos frecuente,Menor gasto,Activo,Recompra,Recompra,Recompra,Desercion,Regreso,Recompra,Recompra,Recompra,Recompra,Recompra,Desercion
15,39.0,12,710.34,1,1,1,Menos reciente,Menos frecuente,Menor gasto,Activo,Recompra,Recompra,Recompra,Desercion,Repite desersion,Repite desersion,Repite desersion,Repite desersion,Repite desersion,Regreso,Desercion
16,22.0,21,1350.85,2,3,4,Poco reciente,Moderada frecuencia,Mayor gasto,Activo,Recompra,Desercion,Repite desersion,Regreso,Recompra,Recompra,Recompra,Recompra,Recompra,Desercion,Regreso
17,6.0,23,1339.46,4,4,3,Más reciente,Más frecuente,Moderado gasto,Activo,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra,Desercion,Regreso,Recompra
18,0.0,27,1669.88,4,4,4,Más reciente,Más frecuente,Mayor gasto,Activo,Desercion,Regreso,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra,Desercion,Regreso,Recompra
19,22.0,21,1309.15,2,3,3,Poco reciente,Moderada frecuencia,Moderado gasto,Activo,Recompra,Recompra,Desercion,Regreso,Recompra,Recompra,Recompra,Recompra,Desercion,Regreso,Recompra
20,36.0,18,1137.69,1,2,2,Menos reciente,Baja frecuencia,Bajo gasto,Activo,Desercion,Regreso,Recompra,Recompra,Recompra,Desercion,Regreso,Recompra,Recompra,Recompra,Desercion
21,0.0,18,1074.76,4,2,1,Más reciente,Baja frecuencia,Menor gasto,Null,Activo,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra
22,12.0,26,1552.71,3,4,4,Moderadamente reciente,Más frecuente,Mayor gasto,Activo,Recompra,Recompra,Recompra,Recompra,Recompra,Desercion,Regreso,Recompra,Recompra,Desercion,Regreso
23,29.0,19,1120.67,1,2,2,Menos reciente,Baja frecuencia,Bajo gasto,Activo,Recompra,Recompra,Recompra,Recompra,Recompra,Desercion,Regreso,Recompra,Recompra,Recompra,Recompra
24,35.0,18,1103.94,1,2,2,Menos reciente,Baja frecuencia,Bajo gasto,Activo,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra,Desercion,Repite desersion,Regreso,Recompra,Desercion
25,5.0,25,1501.81,4,4,4,Más reciente,Más frecuente,Mayor gasto,Activo,Recompra,Desercion,Regreso,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra
26,20.0,20,1186.54,2,3,3,Poco reciente,Moderada frecuencia,Moderado gasto,Activo,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra
27,28.0,22,1394.24,1,3,4,Menos reciente,Moderada frecuencia,Mayor gasto,Activo,Recompra,Recompra,Recompra,Desercion,Regreso,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra
28,20.0,19,1140.86,2,2,2,Poco reciente,Baja frecuencia,Bajo gasto,Activo,Recompra,Desercion,Regreso,Recompra,Desercion,Regreso,Recompra,Desercion,Regreso,Desercion,Regreso
29,37.0,23,1451.31,1,4,4,Menos reciente,Más frecuente,Mayor gasto,Activo,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra,Desercion
30,20.0,17,1050.52,2,1,1,Poco reciente,Menos frecuente,Menor gasto,Activo,Recompra,Desercion,Regreso,Recompra,Recompra,Desercion,Regreso,Recompra,Recompra,Recompra,Recompra
31,6.0,20,1279.59,4,3,3,Más reciente,Moderada frecuencia,Moderado gasto,Activo,Desercion,Repite desersion,Regreso,Desercion,Regreso,Desercion,Regreso,Recompra,Recompra,Recompra,Recompra
32,1.0,22,1317.93,4,3,3,Más reciente,Moderada frecuencia,Moderado gasto,Activo,Recompra,Recompra,Desercion,Regreso,Recompra,Recompra,Recompra,Desercion,Regreso,Recompra,Recompra
33,8.0,19,1097.03,3,2,2,Moderadamente reciente,Baja frecuencia,Bajo gasto,Activo,Recompra,Recompra,Recompra,Recompra,Recompra,Desercion,Repite desersion,Regreso,Recompra,Recompra,Recompra
34,8.0,22,1356.74,3,3,4,Moderadamente reciente,Moderada frecuencia,Mayor gasto,Activo,Recompra,Desercion,Repite desersion,Repite desersion,Regreso,Recompra,Desercion,Regreso,Recompra,Recompra,Recompra
35,9.0,18,1114.95,3,2,2,Moderadamente reciente,Baja frecuencia,Bajo gasto,Activo,Recompra,Recompra,Recompra,Recompra,Recompra,Desercion,Regreso,Recompra,Desercion,Regreso,Recompra
36,32.0,17,1076.88,1,1,2,Menos reciente,Menos frecuente,Bajo gasto,Activo,Desercion,Regreso,Desercion,Regreso,Recompra,Recompra,Recompra,Desercion,Regreso,Recompra,Desercion
37,4.0,20,1178.09,4,3,2,Más reciente,Moderada frecuencia,Bajo gasto,Null,Activo,Desercion,Regreso,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra
38,31.0,13,856.65,1,1,1,Menos reciente,Menos frecuente,Menor gasto,Activo,Recompra,Desercion,Regreso,Desercion,Regreso,Desercion,Regreso,Recompra,Recompra,Recompra,Desercion
39,13.0,25,1561.71,3,4,4,Moderadamente reciente,Más frecuente,Mayor gasto,Null,Activo,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra,Desercion,Regreso,Recompra
40,7.0,20,1185.94,3,3,3,Moderadamente reciente,Moderada frecuencia,Moderado gasto,Activo,Recompra,Recompra,Recompra,Recompra,Desercion,Regreso,Recompra,Recompra,Recompra,Desercion,Regreso
41,38.0,20,1206.89,1,3,3,Menos reciente,Moderada frecuencia,Moderado gasto,Activo,Recompra,Recompra,Desercion,Regreso,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra,Desercion
42,3.0,26,1545.13,4,4,4,Más reciente,Más frecuente,Mayor gasto,Activo,Recompra,Recompra,Recompra,Recompra,Desercion,Regreso,Recompra,Recompra,Recompra,Recompra,Recompra
43,4.0,23,1446.01,4,4,4,Más reciente,Más frecuente,Mayor gasto,Activo,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra,Desercion,Regreso,Recompra
44,19.0,19,1136.9,2,2,2,Poco reciente,Baja frecuencia,Bajo gasto,Activo,Recompra,Recompra,Desercion,Regreso,Recompra,Recompra,Recompra,Recompra,Recompra,Desercion,Regreso
45,45.0,17,1029.66,1,1,1,Menos reciente,Menos frecuente,Menor gasto,Null,Activo,Recompra,Recompra,Desercion,Regreso,Recompra,Desercion,Regreso,Recompra,Recompra,Desercion
46,51.0,16,906.86,1,1,1,Menos reciente,Menos frecuente,Menor gasto,Activo,Recompra,Recompra,Recompra,Recompra,Desercion,Repite desersion,Regreso,Recompra,Recompra,Recompra,Desercion
47,13.0,14,824.4,3,1,1,Moderadamente reciente,Menos frecuente,Menor gasto,Activo,Recompra,Desercion,Regreso,Recompra,Recompra,Recompra,Desercion,Repite desersion,Regreso,Recompra,Recompra
48,1.0,20,1240.81,4,3,3,Más reciente,Moderada frecuencia,Moderado gasto,Null,Activo,Recompra,Desercion,Regreso,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra
49,3.0,19,1145.9,4,2,2,Más reciente,Baja frecuencia,Bajo gasto,Activo,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra,Desercion,Regreso,Recompra,Desercion,Regreso
50,15.0,19,1189.59,2,2,3,Poco reciente,Baja frecuencia,Moderado gasto,Activo,Recompra,Recompra,Recompra,Desercion,Regreso,Recompra,Recompra,Recompra,Recompra,Recompra,Recompra
`;

        let cohortChart, recencyChart, frequencyChart, monetaryChart;
        let originalData = [];
        
        // --- DATA PARSING AND PREPARATION ---
        function parseData() {
            const rows = csvData.trim().split('\n');
            const headers = rows.shift().split(',');
            return rows.map(row => {
                const values = row.split(',');
                let obj = {};
                headers.forEach((header, i) => {
                    let value = values[i];
                    // Convert numeric fields from string to number
                    if (['Recency', 'Frequency', 'Monetary'].includes(header)) {
                        value = parseFloat(value);
                    }
                    obj[header] = value;
                });
                return obj;
            });
        }

        // --- CHART CREATION AND UPDATING ---
        function createCharts() {
            const chartOptions = {
                maintainAspectRatio: false,
                responsive: true,
                plugins: {
                    legend: {
                        labels: { color: 'white' }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: 'white' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    y: {
                        ticks: { color: 'white' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    }
                }
            };
            
            const barChartOptions = { ...chartOptions, indexAxis: 'y' };

            cohortChart = new Chart(document.getElementById('cohort-chart'), { type: 'line', options: chartOptions });
            recencyChart = new Chart(document.getElementById('recency-chart'), { type: 'bar', options: barChartOptions });
            frequencyChart = new Chart(document.getElementById('frequency-chart'), { type: 'bar', options: barChartOptions });
            monetaryChart = new Chart(document.getElementById('monetary-chart'), { type: 'bar', options: barChartOptions });
        }

        function updateDashboard(data) {
            // Update KPIs
            updateKPIs(data);

            // Update Cohort Chart
            updateCohortChart(data);

            // Update RFM Charts
            updateRFMCharts(data);
        }

        function updateKPIs(data) {
            document.getElementById('total-customers').textContent = data.length;
            if (data.length === 0) {
                document.getElementById('avg-recency').textContent = '0';
                document.getElementById('avg-frequency').textContent = '0';
                document.getElementById('avg-monetary').textContent = '0.00';
                return;
            }
            const avgRecency = data.reduce((sum, d) => sum + d.Recency, 0) / data.length;
            const avgFrequency = data.reduce((sum, d) => sum + d.Frequency, 0) / data.length;
            const avgMonetary = data.reduce((sum, d) => sum + d.Monetary, 0) / data.length;

            document.getElementById('avg-recency').textContent = avgRecency.toFixed(1);
            document.getElementById('avg-frequency').textContent = avgFrequency.toFixed(1);
            document.getElementById('avg-monetary').textContent = avgMonetary.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        
        function updateCohortChart(data) {
            const periods = Array.from({ length: 12 }, (_, i) => `Estado_${i + 1}`);
            const states = ['Activo', 'Recompra', 'Desercion', 'Regreso', 'Repite desersion'];
            const stateColors = {
                'Activo': 'rgba(54, 162, 235, 0.7)',
                'Recompra': 'rgba(75, 192, 192, 0.7)',
                'Desercion': 'rgba(255, 99, 132, 0.7)',
                'Regreso': 'rgba(255, 206, 86, 0.7)',
                'Repite desersion': 'rgba(153, 102, 255, 0.7)'
            };

            const datasets = states.map(state => {
                const counts = periods.map(period => {
                    return data.filter(d => d[period] === state).length;
                });
                return {
                    label: state,
                    data: counts,
                    borderColor: stateColors[state],
                    backgroundColor: stateColors[state],
                    fill: false,
                    tension: 0.1
                };
            });
            
            cohortChart.data = {
                labels: periods.map(p => `Periodo ${p.split('_')[1]}`),
                datasets: datasets
            };
            cohortChart.update();
        }
        
        function updateRFMCharts(data) {
             const rfmColors = ['#06b6d4', '#0891b2', '#0e7490', '#155e75'];
             
            // Recency Chart
            const rData = processRFMData(data, 'R_label');
            recencyChart.data = { labels: rData.labels, datasets: [{ label: 'Clientes', data: rData.counts, backgroundColor: rfmColors }] };
            recencyChart.update();
            
            // Frequency Chart
            const fData = processRFMData(data, 'F_label');
            frequencyChart.data = { labels: fData.labels, datasets: [{ label: 'Clientes', data: fData.counts, backgroundColor: rfmColors }] };
            frequencyChart.update();
            
            // Monetary Chart
            const mData = processRFMData(data, 'M_label');
            monetaryChart.data = { labels: mData.labels, datasets: [{ label: 'Clientes', data: mData.counts, backgroundColor: rfmColors }] };
            monetaryChart.update();
        }
        
        function processRFMData(data, labelKey) {
            const counts = data.reduce((acc, d) => {
                acc[d[labelKey]] = (acc[d[labelKey]] || 0) + 1;
                return acc;
            }, {});
            
            const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
            return {
                labels: sorted.map(item => item[0]),
                counts: sorted.map(item => item[1])
            };
        }


        // --- FILTERS ---
        function setupFilters() {
            const rFilter = document.getElementById('r-label-filter');
            const fFilter = document.getElementById('f-label-filter');
            const mFilter = document.getElementById('m-label-filter');

            const rOptions = ['Todos', ...new Set(originalData.map(d => d.R_label))];
            const fOptions = ['Todos', ...new Set(originalData.map(d => d.F_label))];
            const mOptions = ['Todos', ...new Set(originalData.map(d => d.M_label))];
            
            populateSelect(rFilter, rOptions);
            populateSelect(fFilter, fOptions);
            populateSelect(mFilter, mOptions);

            [rFilter, fFilter, mFilter].forEach(filter => {
                filter.addEventListener('change', applyFilters);
            });
        }
        
        function populateSelect(selectElement, options) {
            selectElement.innerHTML = '';
            options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                selectElement.appendChild(opt);
            });
        }
        
        function applyFilters() {
            const rValue = document.getElementById('r-label-filter').value;
            const fValue = document.getElementById('f-label-filter').value;
            const mValue = document.getElementById('m-label-filter').value;

            let filteredData = originalData.filter(d => {
                const rMatch = rValue === 'Todos' || d.R_label === rValue;
                const fMatch = fValue === 'Todos' || d.F_label === fValue;
                const mMatch = mValue === 'Todos' || d.M_label === mValue;
                return rMatch && fMatch && mMatch;
            });
            
            updateDashboard(filteredData);
        }


        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            originalData = parseData();
            createCharts();
            setupFilters();
            updateDashboard(originalData);
        });

    </script>
</body>
</html>
